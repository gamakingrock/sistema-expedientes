<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestión de Expedientes</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #003366;
            --secondary-color: #0066CC;
            --light-color: #f8f9fa;
            --dark-color: #212529;
        }
        
        body {
            background-color: #f5f7fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }
        
        .login-container {
            max-width: 450px;
            margin: 20px auto 50px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 25px 20px;
            text-align: center;
            margin-bottom: 15px;
        }
        
        .centered-title {
            color: white;
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: 1px;
            margin-bottom: 10px;
            text-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
            position: relative;
            display: inline-block;
            padding: 0 20px;
        }
        
        .centered-title:after {
            content: "";
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 3px;
            background: linear-gradient(to right, white, rgba(255, 255, 255, 0.5));
            border-radius: 1.5px;
        }
        
        .centered-subtitle {
            color: rgba(255, 255, 255, 0.92);
            font-size: 1.25rem;
            font-weight: 400;
            max-width: 700px;
            margin: 0 auto;
            padding: 0 15px;
            opacity: 0.9;
            letter-spacing: 0.3px;
            line-height: 1.5;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        .logo-container {
            padding: 15px 0;
            text-align: center;
        }
        
        .logo-container img {
            max-width: 200px;
            height: auto;
            max-height: 80px;
        }
        
        .form-floating > label {
            padding: 1rem 0.75rem;
        }
        
        .form-floating > .form-control,
        .form-floating > .form-select {
            padding: 1rem 0.75rem;
        }
        
        .btn-primary {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            border: none;
            padding: 0.75rem 0;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 51, 102, 0.2);
            background: linear-gradient(to right, #002244, #0055AA);
        }
        
        .error-message {
            background-color: #fff5f5;
            border-left: 4px solid #dc3545;
            padding: 10px 15px;
            margin-bottom: 20px;
            border-radius: 0 4px 4px 0;
            display: none;
        }
        
        .panel-container {
            max-width: 1200px;
            margin: 30px auto;
        }
        
        .card {
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
            border: none;
            overflow: hidden;
        }
        
        .card-header {
            background: white;
            border-bottom: 1px solid #eee;
            padding: 15px 20px;
            font-weight: 600;
        }
        
        .profile-picture-container {
            position: relative;
            display: inline-block;
        }
        
        .profile-picture-container img {
            border: 3px solid var(--secondary-color);
            transition: all 0.3s ease;
        }
        
        .profile-picture-container:hover img {
            transform: scale(1.03);
        }
        
        .upload-icon {
            position: absolute;
            bottom: 5px;
            right: 35px;
        }
        
        #personal-list td {
            vertical-align: middle;
        }
        
        #personal-list img {
            width: 40px;
            height: 40px;
            object-fit: cover;
        }
        
        .table th {
            font-weight: 600;
            background-color: #f8f9fa;
        }
        
        .table-hover tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .form-label {
            font-weight: 500;
            color: #495057;
        }
        
        .form-control, .form-select {
            border: 1px solid #ced4da;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 1rem;
            transition: all 0.2s;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        
        .footer {
            text-align: center;
            padding: 20px 0;
            color: #6c757d;
            font-size: 14px;
            margin-top: 40px;
            border-top: 1px solid #eee;
        }
        
        .footer-line {
            height: 1px;
            background: linear-gradient(to right, transparent, #ced4da, transparent);
            margin-bottom: 15px;
        }
        
        .security-info {
            background: rgba(0, 51, 102, 0.05);
            border-left: 3px solid var(--secondary-color);
            padding: 15px;
            border-radius: 0 8px 8px 0;
            margin-top: 20px;
            font-size: 14px;
        }
        
        .security-icon {
            color: var(--secondary-color);
            margin-right: 8px;
        }
        
        @media (max-width: 576px) {
            .login-container {
                padding: 30px 20px;
                margin: 20px;
            }
            
            .footer {
                font-size: 16px;
                padding: 20px 0;
            }
        }
        
        /* Estilos para "Recordar mis credenciales" */
        .form-check-input {
            margin-top: 6px;
            cursor: pointer;
        }
        
        .form-check-label {
            cursor: pointer;
            color: #6c757d;
            transition: all 0.2s;
        }
        
        .form-check-input:focus {
            box-shadow: 0 0 0 0.25rem rgba(0, 102, 204, 0.25);
        }
        
        /* Estilos para la paginación */
        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: #f8f9fa;
            border-top: 1px solid #eee;
            border-radius: 0 0 12px 12px;
        }
        
        .pagination-info {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .pagination-buttons {
            display: flex;
            gap: 5px;
        }
        
        .pagination-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            background-color: white;
            border: 1px solid #ced4da;
            color: #495057;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .pagination-btn:hover {
            background-color: #e9ecef;
            border-color: #adb5bd;
        }
        
        .pagination-btn.active {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
            color: white;
        }
        
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 5px solid rgba(0, 99, 204, 0.3);
            border-radius: 50%;
            border-top-color: #0066CC;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Capa de carga -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
    </div>
    
    <!-- Header con título centrado -->
    <div class="header" id="main-title-section">
        <h1 class="centered-title">SISTEMA DE GESTIÓN DE EXPEDIENTES</h1>
        <p class="centered-subtitle">Registre y gestione expedientes de manera sencilla</p>
    </div>
    
    <!-- Pantalla de Login -->
    <div class="container" id="login-screen">
        <div class="login-container">
            <div class="card border-0">
                <div class="card-body p-4">
                    <!-- Contenedor del logo -->
                    <div class="logo-container text-center mb-4">
                        <img src="https://raw.githubusercontent.com/gamakingrock/sistema-expedientes/main/images/policia-nacional-bolivariana.png" 
                             alt="Logo Policía Nacional Bolivariana" 
                             class="img-fluid">
                    </div>
                    
                    <h2 class="card-title text-center mb-4">Iniciar Sesión</h2>
                    <div id="error-message" class="error-message">
                        <i class="fas fa-exclamation-circle me-2"></i><span id="error-text"></span>
                    </div>
                    <form id="login-form">
                        <div class="mb-3">
                            <div class="form-floating">
                                <input type="email" class="form-control" id="email" required>
                                <label for="email"><i class="fas fa-envelope me-2"></i>Correo electrónico</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-floating">
                                <input type="password" class="form-control" id="password" required>
                                <label for="password"><i class="fas fa-lock me-2"></i>Contraseña</label>
                            </div>
                        </div>
                        <!-- Checkbox para "Recordar mis credenciales" -->
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="remember-credentials">
                            <label class="form-check-label" for="remember-credentials">Recordar mis credenciales</label>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <span id="login-spinner" class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
                            <span id="login-text">Iniciar Sesión</span>
                        </button>
                        <div class="mt-3 text-center">
                            <button type="button" class="btn btn-link" id="show-register">¿No tienes cuenta? Regístrate</button>
                        </div>
                    </form>
                    
                    <!-- Formulario de Registro -->
                    <form id="register-form" class="d-none mt-4">
                        <h3 class="text-center mb-3">Crear Cuenta</h3>
                        <div class="mb-3">
                            <div class="form-floating">
                                <input type="email" class="form-control" id="reg-email" required>
                                <label for="reg-email"><i class="fas fa-envelope me-2"></i>Correo electrónico</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-floating">
                                <input type="password" class="form-control" id="reg-password" required>
                                <label for="reg-password"><i class="fas fa-lock me-2"></i>Contraseña</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="reg-name" required>
                                <label for="reg-name"><i class="fas fa-user me-2"></i>Nombre completo</label>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Crear Cuenta</button>
                        <div class="mt-3 text-center">
                            <button type="button" class="btn btn-link" id="show-login">¿Ya tienes cuenta? Inicia sesión</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Información de seguridad -->
            <div class="security-info">
                <i class="fas fa-shield-alt security-icon"></i>
                Su información está protegida con encriptación de extremo a extremo
            </div>
        </div>
    </div>
    
    <!-- Panel Principal (oculto al inicio) -->
    <div class="container panel-container" id="main-panel" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Bienvenido, <span id="user-name" class="text-primary"></span></h2>
            <button id="logout-btn" class="btn btn-outline-danger">
                <i class="fas fa-sign-out-alt me-2"></i>Cerrar sesión
            </button>
        </div>
        
        <!-- Panel de Registro de Personal -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0">Registro de Personal</h5>
            </div>
            <div class="card-body">
                <form id="personal-form">
                    <div class="row mb-4">
                        <div class="col-md-4 text-center">
                            <div class="profile-picture-container mb-3 position-relative">
                                <img src="https://placehold.co/200x200/003366/white?text=Foto+Personal" 
                                     alt="Foto del personal" 
                                     class="img-fluid rounded-circle" 
                                     id="profile-picture"
                                     style="width: 180px; height: 180px; object-fit: cover;">
                                <div class="upload-icon" style="position: absolute; bottom: 5px; right: 35px;">
                                    <label for="profile-picture-upload" class="btn btn-primary btn-sm rounded-circle p-2" 
                                           style="cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                                        <i class="fas fa-camera"></i>
                                    </label>
                                    <input type="file" id="profile-picture-upload" class="d-none" accept="image/*">
                                </div>
                            </div>
                            <p class="text-muted small">Haga clic en el ícono para subir una foto</p>
                        </div>
                        <div class="col-md-8">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="nombres" class="form-label">Nombres</label>
                                    <input type="text" class="form-control" id="nombres" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="apellidos" class="form-label">Apellidos</label>
                                    <input type="text" class="form-control" id="apellidos" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="cedula" class="form-label">Cédula de Identidad</label>
                                    <input type="text" class="form-control" id="cedula" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="edad" class="form-label">Edad</label>
                                    <input type="number" class="form-control" id="edad" min="18" max="70">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="jerarquia" class="form-label">Jerarquía</label>
                            <select class="form-select" id="jerarquia" required>
                                <option value="">Seleccione...</option>
                                <option value="general">General</option>
                                <option value="coronel">Coronel</option>
                                <option value="teniente-coronel">Teniente Coronel</option>
                                <option value="mayor">Mayor</option>
                                <option value="capitan">Capitán</option>
                                <option value="teniente">Teniente</option>
                                <option value="subteniente">Subteniente</option>
                                <option value="sargento-mayor">Sargento Mayor</option>
                                <option value="sargento">Sargento</option>
                                <option value="cabo">Cabo</option>
                                <option value="soldado">Soldado</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="sexo" class="form-label">Sexo</label>
                            <select class="form-select" id="sexo" required>
                                <option value="">Seleccione...</option>
                                <option value="masculino">Masculino</option>
                                <option value="femenino">Femenino</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Nuevos campos como desplegables -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="fecha-inicio" class="form-label">Fecha de Inicio</label>
                            <input type="date" class="form-control" id="fecha-inicio">
                        </div>
                        <div class="col-md-6">
                            <label for="tipo-expediente" class="form-label">Tipo de Expediente</label>
                            <select class="form-select" id="tipo-expediente">
                                <option value="">Seleccione...</option>
                                <option value="administrativo">Administrativo</option>
                                <option value="disciplinario">Disciplinario</option>
                                <option value="penal">Penal</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="icap" class="form-label">ICAP (Oficina)</label>
                            <select class="form-select" id="icap">
                                <option value="">Seleccione...</option>
                                <option value="zulia">Zulia</option>
                                <option value="caracas">Caracas</option>
                                <option value="miranda">Miranda</option>
                                <option value="aragua">Aragua</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="condicion" class="form-label">Condición del Funcionario en el Caso</label>
                            <select class="form-select" id="condicion">
                                <option value="">Seleccione...</option>
                                <option value="investigado">Investigado</option>
                                <option value="imputado">Imputado</option>
                                <option value="acusado">Acusado</option>
                                <option value="condenado">Condenado</option>
                                <option value="absuelto">Absuelto</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="anio" class="form-label">Año</label>
                            <select class="form-select" id="anio">
                                <option value="">Seleccione...</option>
                                <option value="2020">2020</option>
                                <option value="2021">2021</option>
                                <option value="2022">2022</option>
                                <option value="2023">2023</option>
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>
                        <!-- Expediente Penal como campo de texto -->
                        <div class="col-md-6">
                            <label for="expediente-penal" class="form-label">Expediente Penal</label>
                            <input type="text" class="form-control" id="expediente-penal" placeholder="Ingrese el número de expediente penal">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="servicio" class="form-label">Servicio donde Labora el Funcionario</label>
                            <select class="form-select" id="servicio">
                                <option value="">Seleccione...</option>
                                <option value="patrullaje">Patrullaje</option>
                                <option value="investigacion">Investigación</option>
                                <option value="transito">Tránsito</option>
                                <option value="seguridad-ciudadana">Seguridad Ciudadana</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="tipo-falta" class="form-label">Tipo de Falta</label>
                            <select class="form-select" id="tipo-falta">
                                <option value="">Seleccione...</option>
                                <option value="leve">Leve</option>
                                <option value="grave">Grave</option>
                                <option value="muy-grave">Muy Grave</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="origen-falta" class="form-label">Origen de la Falta</label>
                            <select class="form-select" id="origen-falta">
                                <option value="">Seleccione...</option>
                                <option value="interna">Interna</option>
                                <option value="externa">Externa</option>
                                <option value="ciudadano">Denuncia Ciudadana</option>
                                <option value="fiscalia">Fiscalía</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="falta" class="form-label">Falta</label>
                            <select class="form-select" id="falta">
                                <option value="">Seleccione...</option>
                                <option value="abandono-servicio">Abandono de Servicio</option>
                                <option value="desobediencia">Desobediencia</option>
                                <option value="malversacion">Malversación</option>
                                <option value="abuso-autoridad">Abuso de Autoridad</option>
                                <option value="corrupcion">Corrupción</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="denunciante" class="form-label">Denunciante</label>
                            <select class="form-select" id="denunciante">
                                <option value="">Seleccione...</option>
                                <option value="ciudadano">Ciudadano</option>
                                <option value="funcionario">Funcionario</option>
                                <option value="fiscal">Fiscal</option>
                                <option value="juez">Juez</option>
                                <option value="familia">Familia</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="detenido" class="form-label">Funcionario Detenido</label>
                            <select class="form-select" id="detenido">
                                <option value="">Seleccione...</option>
                                <option value="si">Sí</option>
                                <option value="no">No</option>
                                <option value="proceso">En Proceso de Detención</option>
                                <option value="libertad">En Libertad</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="estatus" class="form-label">Estatus</label>
                            <select class="form-select" id="estatus">
                                <option value="">Seleccione...</option>
                                <option value="abierto">Abierto</option>
                                <option value="en-proceso">En Proceso</option>
                                <option value="cerrado">Cerrado</option>
                                <option value="archivado">Archivado</option>
                                <option value="en-juicio">En Juicio</option>
                                <option value="sentencia">Sentencia</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="decision" class="form-label">Decisión</label>
                            <select class="form-select" id="decision">
                                <option value="">Seleccione...</option>
                                <option value="sancion">Sanción</option>
                                <option value="archivado">Archivado</option>
                                <option value="absuelto">Absuelto</option>
                                <option value="proceso">En Proceso</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Nuevos campos adicionales solicitados -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="expediente-numero" class="form-label">Expediente Número</label>
                            <input type="text" class="form-control" id="expediente-numero" placeholder="Ej: ZUL-2023-001">
                        </div>
                        <div class="col-md-6">
                            <label for="registrado-por" class="form-label">Registrado por</label>
                            <input type="text" class="form-control" id="registrado-por" placeholder="Nombre del registrador">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="sustanciador" class="form-label">Sustanciador</label>
                            <input type="text" class="form-control" id="sustanciador" placeholder="Nombre del sustanciador">
                        </div>
                        <div class="col-md-6">
                            <label for="remision" class="form-label">Remisión</label>
                            <input type="text" class="form-control" id="remision" placeholder="Remisión del caso">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="resena" class="form-label">Reseña</label>
                        <textarea class="form-control" id="resena" rows="2" placeholder="Reseña del caso..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="causa" class="form-label">Causa</label>
                        <textarea class="form-control" id="causa" rows="2" placeholder="Causa del caso..."></textarea>
                    </div>
                    
                    <div class="d-flex justify-content-between mb-4">
                        <!-- Botón para exportar a Excel -->
                        <button id="export-excel-btn" class="btn btn-success">
                            <i class="fas fa-file-excel me-2"></i>Exportar a Excel
                        </button>
                        
                        <!-- Botón para guardar -->
                        <button type="submit" class="btn btn-primary py-2">
                            <i class="fas fa-save me-2"></i>Registrar Nuevo Personal
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Lista de Personal Registrado -->
        <div class="card shadow-sm">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Personal Registrado</h5>
                <div class="d-flex">
                    <div class="input-group w-auto me-2" style="max-width: 300px;">
                        <span class="input-group-text bg-light">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control" id="search-personal" placeholder="Buscar...">
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Número</th>
                                <th>Foto</th>
                                <th>Nombres</th>
                                <th>Apellidos</th>
                                <th>Cédula</th>
                                <th>Jerarquía</th>
                                <th>Registrado por</th>
                                <th>Fecha Registro</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="personal-list">
                            <!-- Los registros de personal se cargarán aquí dinámicamente -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Controles de paginación -->
                <div class="pagination-controls">
                    <div class="pagination-info" id="pagination-info">
                        Mostrando 0 de 0 registros
                    </div>
                    <div class="pagination-buttons">
                        <button id="first-page" class="pagination-btn" title="Primera página">
                            <i class="fas fa-angle-double-left"></i>
                        </button>
                        <button id="prev-page" class="pagination-btn" title="Página anterior">
                            <i class="fas fa-angle-left"></i>
                        </button>
                        <button id="current-page" class="pagination-btn active" disabled>1</button>
                        <button id="next-page" class="pagination-btn" title="Página siguiente">
                            <i class="fas fa-angle-right"></i>
                        </button>
                        <button id="last-page" class="pagination-btn" title="Última página">
                            <i class="fas fa-angle-double-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Pie de página mejorado con texto en minúsculas -->
    <div class="footer">
        <div class="footer-line"></div>
        <div class="footer-content">
            <div class="footer-text">
                sistema de gestión de expedientes - todos los derechos reservados © 2025 / REDIP OCCIDENTAL - CCPE ZULIA - OTIC ZULIA
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- SheetJS (xlsx) para exportación a Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        // Variables de paginación
        let currentPage = 1;
        let itemsPerPage = 10; // Aumentado de 6 a 10 para mejor rendimiento
        let allPersonalData = [];
        let filteredPersonalData = [];
        let loadingTimer = null;
        
        // Configuración de Supabase
        const supabaseUrl = 'https://sgcozosmelxzsjcecqrl.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNnY296b3NtZWx4enNqY2VjcXJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwMDI4NjYsImV4cCI6MjA2OTU3ODg2Nn0.OpBo_hAeq_EDreiMKiuQyk5o-5nbr8jWcbw4mr0_1I0';

        // Inicialización CORRECTA de Supabase
        const { createClient } = supabase;
        const supabaseClient = createClient(supabaseUrl, supabaseKey, {
            auth: {
                autoRefreshToken: true,
                persistSession: true,
                detectSessionInUrl: true
            }
        });

        // Elementos del DOM
        const loginScreen = document.getElementById('login-screen');
        const mainPanel = document.getElementById('main-panel');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const loginSpinner = document.getElementById('login-spinner');
        const loginText = document.getElementById('login-text');
        const logoutBtn = document.getElementById('logout-btn');
        const showRegisterBtn = document.getElementById('show-register');
        const showLoginBtn = document.getElementById('show-login');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const exportExcelBtn = document.getElementById('export-excel-btn');
        const searchPersonal = document.getElementById('search-personal');
        const loadingOverlay = document.getElementById('loading-overlay');
        
        // Elementos de paginación
        const paginationInfo = document.getElementById('pagination-info');
        const firstPageBtn = document.getElementById('first-page');
        const prevPageBtn = document.getElementById('prev-page');
        const currentPageBtn = document.getElementById('current-page');
        const nextPageBtn = document.getElementById('next-page');
        const lastPageBtn = document.getElementById('last-page');

        // Variables globales
        let editingPersonalId = null;
        let isSaving = false; // Flag para evitar guardados duplicados
        let currentUserRole = 'user'; // Por defecto es usuario normal

        // Función para mostrar mensajes de error
        function showError(message) {
            if (errorText && errorMessage) {
                errorText.textContent = message;
                errorMessage.style.display = 'block';
            }
            console.error('Error:', message);
        }

        // Función para ocultar mensajes de error
        function hideError() {
            if (errorMessage) {
                errorMessage.style.display = 'none';
            }
        }

        // Función para mostrar el overlay de carga
        function showLoading() {
            // Limpia cualquier temporizador anterior
            if (loadingTimer) {
                clearTimeout(loadingTimer);
            }
            
            // Muestra el overlay después de 300ms (para evitar parpadeos)
            loadingTimer = setTimeout(() => {
                loadingOverlay.style.display = 'flex';
            }, 300);
        }

        // Función para ocultar el overlay de carga
        function hideLoading() {
            // Cancela el temporizador si existe
            if (loadingTimer) {
                clearTimeout(loadingTimer);
                loadingTimer = null;
            }
            
            loadingOverlay.style.display = 'none';
        }

        // Función para guardar el correo recordado
        function saveRememberedEmail(email) {
            try {
                localStorage.setItem('rememberedEmail', email);
            } catch (e) {
                console.warn("No se pudo guardar el correo en localStorage");
            }
        }

        // Función para obtener el correo recordado
        function getRememberedEmail() {
            try {
                return localStorage.getItem('rememberedEmail') || '';
            } catch (e) {
                console.warn("No se pudo obtener el correo de localStorage");
                return '';
            }
        }

        // Función para limpiar el correo recordado
        function clearRememberedEmail() {
            try {
                localStorage.removeItem('rememberedEmail');
            } catch (e) {
                console.warn("No se pudo limpiar el correo de localStorage");
            }
        }

        // Función CORREGIDA para verificar si la sesión es válida
        async function isSessionValid() {
            try {
                // CORRECCIÓN AQUÍ - Manejo seguro de la sesión
                const { data, error } = await supabaseClient.auth.getSession();
                if (error) {
                    console.error('Error al obtener sesión:', error);
                    return false;
                }
                return !!data?.session;
            } catch (error) {
                console.error('Error al verificar validez de sesión:', error);
                return false;
            }
        }

        // Función CORREGIDA para verificar la sesión
        async function checkSession() {
            try {
                console.log('Verificando sesión...');
                
                // CORRECCIÓN AQUÍ - Manejo seguro de la sesión
                const { data, error } = await supabaseClient.auth.getSession();
                
                if (error) {
                    console.error('Error al obtener sesión:', error);
                    throw error;
                }
                
                if (data?.session) {
                    console.log('Sesión encontrada:', data.session);
                    
                    // Usuario autenticado - muestra el panel principal
                    loginScreen.style.display = 'none';
                    mainPanel.style.display = 'block';
                    
                    // Muestra el nombre del usuario
                    const user = data.session.user;
                    const userNameElement = document.getElementById('user-name');
                    if (userNameElement) {
                        // CORRECCIÓN AQUÍ - Manejo seguro de user_metadata
                        const fullName = user.user_metadata?.full_name || 
                                        user.user_metadata?.fullName || 
                                        user.user_metadata?.name ||
                                        user.email?.split('@')[0] || 'Usuario';
                        
                        userNameElement.textContent = fullName;
                        
                        // Verificar el rol del usuario
                        const userRole = user.user_metadata?.role || 'user';
                        currentUserRole = userRole;
                        
                        console.log('ROL DEL USUARIO:', userRole);
                        
                        // Carga los registros de personal
                        await loadPersonal();
                    }
                } else {
                    console.log('No hay sesión activa');
                    
                    // Usuario no autenticado - muestra el login
                    loginScreen.style.display = 'block';
                    mainPanel.style.display = 'none';
                    
                    // Rellenar el correo si está guardado
                    const rememberedEmail = getRememberedEmail();
                    if (rememberedEmail) {
                        document.getElementById('email').value = rememberedEmail;
                        document.getElementById('remember-credentials').checked = true;
                    }
                }
            } catch (error) {
                console.error('Error al verificar sesión:', error);
                showError('Error al verificar sesión: ' + error.message);
            }
        }

        // Función para formatear la fecha
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        // Función para actualizar la interfaz de paginación
        function updatePaginationControls() {
            const totalPages = Math.ceil(filteredPersonalData.length / itemsPerPage);
            
            // Actualizar información de paginación
            const startItem = (currentPage - 1) * itemsPerPage + 1;
            const endItem = Math.min(currentPage * itemsPerPage, filteredPersonalData.length);
            paginationInfo.textContent = `Mostrando ${startItem}-${endItem} de ${filteredPersonalData.length} registros`;
            
            // Actualizar estado de los botones
            firstPageBtn.disabled = currentPage === 1;
            prevPageBtn.disabled = currentPage === 1;
            currentPageBtn.textContent = currentPage;
            nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
            lastPageBtn.disabled = currentPage === totalPages || totalPages === 0;
        }

        // Función para renderizar la página actual
        function renderCurrentPage() {
            const personalList = document.getElementById('personal-list');
            if (!personalList) return;
            
            // Calcular índices para la paginación
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredPersonalData.length);
            
            // Limpiar la tabla
            personalList.innerHTML = '';
            
            // Mostrar mensaje si no hay registros
            if (filteredPersonalData.length === 0) {
                personalList.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center py-4 text-muted">
                            <i class="fas fa-inbox me-2"></i>No hay registros de personal
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Agregar los registros de la página actual
            for (let i = startIndex; i < endIndex; i++) {
                const personal = filteredPersonalData[i];
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${personal.expediente_numero || 'N/A'}</td>
                    <td><img src="${personal.foto || 'https://placehold.co/40x40/003366/white?text=FP'}" 
                             class="rounded-circle" width="40"></td>
                    <td>${personal.nombres || 'N/A'}</td>
                    <td>${personal.apellidos || 'N/A'}</td>
                    <td>${personal.cedula || 'N/A'}</td>
                    <td>${personal.jerarquia || 'N/A'}</td>
                    <td>${personal.registrado_por || 'N/A'}</td>
                    <td>${formatDate(personal.fecha_registro)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary edit-personal" data-id="${personal.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-personal ms-1" data-id="${personal.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                personalList.appendChild(row);
            }
            
            // Configurar eventos para los botones de acción
            document.querySelectorAll('.edit-personal').forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    editPersonal(id);
                });
            });
            
            document.querySelectorAll('.delete-personal').forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    deletePersonal(id);
                });
            });
        }

        // Función para ir a una página específica
        function goToPage(page) {
            const totalPages = Math.ceil(filteredPersonalData.length / itemsPerPage);
            
            // Validar que la página esté dentro del rango
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            renderCurrentPage();
            updatePaginationControls();
        }

        // Función CORREGIDA para exportar a Excel con plantilla personalizada
        function exportToExcel() {
            try {
                // Mostrar loader
                showLoading();
                
                // Verificar que hay datos para exportar
                if (allPersonalData.length === 0) {
                    alert('No hay datos para exportar');
                    hideLoading();
                    return;
                }
                
                // Crear un nuevo libro de trabajo
                const wb = XLSX.utils.book_new();
                
                // 1. Hoja de Resumen Ejecutivo
                const summaryData = [
                    ['REPORTE DE EXPEDIENTES DE PERSONAL', '', '', '', '', '', ''],
                    ['Fecha de Generación:', new Date().toLocaleDateString('es-ES'), '', '', 'Total de Registros:', allPersonalData.length, ''],
                    [''],
                    ['RESUMEN POR JERARQUÍA', '', '', '', '', '', ''],
                    ['Jerarquía', 'Cantidad', '', 'RESUMEN POR ESTATUS', '', 'Cantidad', ''],
                ];
                
                // Calcular resumen por jerarquía
                const jerarquiaCount = {};
                allPersonalData.forEach(personal => {
                    const jerarquia = personal.jerarquia || 'Sin jerarquía';
                    jerarquiaCount[jerarquia] = (jerarquiaCount[jerarquia] || 0) + 1;
                });
                
                // Calcular resumen por estatus
                const estatusCount = {};
                allPersonalData.forEach(personal => {
                    const estatus = personal.estatus || 'Sin estatus';
                    estatusCount[estatus] = (estatusCount[estatus] || 0) + 1;
                });
                
                // Añadir datos de jerarquía al resumen
                Object.keys(jerarquiaCount).forEach(jerarquia => {
                    summaryData.push([jerarquia, jerarquiaCount[jerarquia]]);
                });
                
                // Añadir espacio entre secciones
                summaryData.push(['', '', '', '']);
                
                // Añadir datos de estatus al resumen
                Object.keys(estatusCount).forEach(estatus => {
                    summaryData.push(['', '', '', estatus, '', estatusCount[estatus]]);
                });
                
                // Añadir información institucional
                summaryData.push(['', '', '', '', '', '', '']);
                summaryData.push(['Institución:', 'Policía Nacional Bolivariana', '', '', 'Fecha:', new Date().toLocaleDateString('es-ES'), '']);
                summaryData.push(['Unidad:', 'REDIP OCCIDENTAL - CCPE ZULIA', '', '', 'Generado por:', document.getElementById('user-name').textContent || 'Usuario', '']);
                
                // Crear la hoja de resumen
                const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
                
                // Aplicar estilos a la hoja de resumen
                const summaryCellStyle = {
                    font: { bold: true, color: { rgb: "000000" } },
                    fill: { fgColor: { rgb: "D3D3D3" } },
                    border: { top: { style: "thin" }, right: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" } }
                };
                
                const summaryHeaderStyle = {
                    font: { bold: true, color: { rgb: "FFFFFF" }, sz: 14 },
                    fill: { fgColor: { rgb: "003366" } },
                    alignment: { horizontal: "center" },
                    border: { top: { style: "thin" }, right: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" } }
                };
                
                // Aplicar estilos a celdas específicas
                wsSummary['!cols'] = [{ wch: 25 }, { wch: 15 }, { wch: 10 }, { wch: 25 }, { wch: 15 }, { wch: 15 }, { wch: 10 }];
                
                // Título principal
                ['A1', 'B1', 'C1', 'D1', 'E1', 'F1', 'G1'].forEach(cell => {
                    if (wsSummary[cell]) wsSummary[cell].s = {
                        font: { bold: true, color: { rgb: "FFFFFF" }, sz: 16 },
                        fill: { fgColor: { rgb: "003366" } },
                        alignment: { horizontal: "center" },
                        border: { top: { style: "thin" }, right: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" } }
                    };
                });
                
                // Fechas y totales
                ['B2', 'F2'].forEach(cell => {
                    if (wsSummary[cell]) wsSummary[cell].s = {
                        font: { bold: true, color: { rgb: "000000" } },
                        fill: { fgColor: { rgb: "E6E6E6" } },
                        border: { top: { style: "thin" }, right: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" } }
                    };
                });
                
                // Títulos de sección
                ['A4', 'D4'].forEach(cell => {
                    if (wsSummary[cell]) wsSummary[cell].s = {
                        font: { bold: true, color: { rgb: "FFFFFF" }, sz: 12 },
                        fill: { fgColor: { rgb: "0066CC" } },
                        border: { top: { style: "thin" }, right: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" } }
                    };
                });
                
                // Añadir la hoja de resumen al libro
                XLSX.utils.book_append_sheet(wb, wsSummary, "Resumen Ejecutivo");
                
                // 2. Hoja de Datos Principales
                const mainData = [
                    [
                        'NÚMERO DE EXPEDIENTE',
                        'NOMBRES',
                        'APELLIDOS',
                        'CÉDULA',
                        'EDAD',
                        'JERARQUÍA',
                        'SEXO',
                        'FECHA INICIO',
                        'TIPO DE EXPEDIENTE',
                        'ICAP',
                        'CONDICIÓN',
                        'AÑO',
                        'EXPEDIENTE PENAL',
                        'SERVICIO',
                        'TIPO DE FALTA',
                        'ORIGEN DE FALTA',
                        'FALTA',
                        'DENUNCIANTE',
                        'DETENIDO',
                        'ESTATUS',
                        'DECISIÓN',
                        'REGISTRADO POR',
                        'SUSTANCIADOR',
                        'REMISIÓN',
                        'RESEÑA',
                        'CAUSA',
                        'FECHA REGISTRO'
                    ]
                ];
                
                // Añadir los datos de personal
                allPersonalData.forEach(personal => {
                    mainData.push([
                        personal.expediente_numero || '',
                        personal.nombres || '',
                        personal.apellidos || '',
                        personal.cedula || '',
                        personal.edad || '',
                        personal.jerarquia || '',
                        personal.sexo || '',
                        personal.fecha_inicio ? new Date(personal.fecha_inicio).toLocaleDateString('es-ES') : '',
                        personal.tipo_expediente || '',
                        personal.icap || '',
                        personal.condicion || '',
                        personal.anio || '',
                        personal.expediente_penal || '',
                        personal.servicio || '',
                        personal.tipo_falta || '',
                        personal.origen_falta || '',
                        personal.falta || '',
                        personal.denunciante || '',
                        personal.detenido || '',
                        personal.estatus || '',
                        personal.decision || '',
                        personal.registrado_por || '',
                        personal.sustanciador || '',
                        personal.remision || '',
                        personal.resena || '',
                        personal.causa || '',
                        personal.fecha_registro ? new Date(personal.fecha_registro).toLocaleDateString('es-ES') : ''
                    ]);
                });
                
                // Crear la hoja de datos principales
                const wsMain = XLSX.utils.aoa_to_sheet(mainData);
                
                // Aplicar estilos a la hoja de datos principales
                wsMain['!cols'] = [
                    { wch: 20 }, { wch: 20 }, { wch: 20 }, { wch: 15 }, { wch: 5 },
                    { wch: 20 }, { wch: 10 }, { wch: 15 }, { wch: 20 }, { wch: 15 },
                    { wch: 15 }, { wch: 5 }, { wch: 20 }, { wch: 20 }, { wch: 15 },
                    { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 },
                    { wch: 15 }, { wch: 20 }, { wch: 20 }, { wch: 20 }, { wch: 30 },
                    { wch: 30 }, { wch: 15 }
                ];
                
                // Estilo para el encabezado
                const headerStyle = {
                    font: { bold: true, color: { rgb: "FFFFFF" } },
                    fill: { fgColor: { rgb: "003366" } },
                    alignment: { horizontal: "center", wrapText: true },
                    border: { top: { style: "thin" }, right: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" } }
                };
                
                // Aplicar estilo al encabezado
                for (let col = 0; col < mainData[0].length; col++) {
                    const cellRef = XLSX.utils.encode_cell({ r: 0, c: col });
                    if (wsMain[cellRef]) {
                        wsMain[cellRef].s = headerStyle;
                    }
                }
                
                // Estilo para las celdas de datos
                const dataCellStyle = {
                    border: { top: { style: "thin" }, right: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" } },
                    alignment: { vertical: "top", wrapText: true }
                };
                
                // Aplicar estilo a las celdas de datos
                for (let row = 1; row < mainData.length; row++) {
                    for (let col = 0; col < mainData[0].length; col++) {
                        const cellRef = XLSX.utils.encode_cell({ r: row, c: col });
                        if (wsMain[cellRef]) {
                            wsMain[cellRef].s = dataCellStyle;
                        }
                    }
                }
                
                // Añadir la hoja de datos principales al libro
                XLSX.utils.book_append_sheet(wb, wsMain, "Datos Principales");
                
                // 3. Hoja de Metadatos
                const metadata = [
                    ['METADATOS DEL REPORTE', '', '', ''],
                    ['Fecha de Generación:', new Date().toLocaleDateString('es-ES'), '', ''],
                    ['Hora de Generación:', new Date().toLocaleTimeString('es-ES'), '', ''],
                    ['Total de Registros:', allPersonalData.length, '', ''],
                    ['Generado por:', document.getElementById('user-name').textContent || 'Usuario', '', ''],
                    ['Unidad:', 'REDIP OCCIDENTAL - CCPE ZULIA', '', ''],
                    ['Sistema:', 'Sistema de Gestión de Expedientes', '', ''],
                    ['Versión:', '1.0', '', ''],
                    ['Fecha de Exportación:', new Date().toLocaleDateString('es-ES'), '', '']
                ];
                
                const wsMetadata = XLSX.utils.aoa_to_sheet(metadata);
                
                // Aplicar estilos a la hoja de metadatos
                wsMetadata['!cols'] = [{ wch: 25 }, { wch: 30 }, { wch: 10 }, { wch: 30 }];
                
                // Título
                if (wsMetadata['A1']) wsMetadata['A1'].s = {
                    font: { bold: true, color: { rgb: "FFFFFF" }, sz: 14 },
                    fill: { fgColor: { rgb: "003366" } },
                    border: { top: { style: "thin" }, right: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" } }
                };
                
                // Etiquetas
                for (let row = 1; row < 9; row++) {
                    const cellRef = `A${row + 1}`;
                    if (wsMetadata[cellRef]) wsMetadata[cellRef].s = {
                        font: { bold: true, color: { rgb: "000000" } },
                        fill: { fgColor: { rgb: "E6E6E6" } },
                        border: { top: { style: "thin" }, right: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" } }
                    };
                }
                
                // Valores
                for (let row = 1; row < 9; row++) {
                    const cellRef = `B${row + 1}`;
                    if (wsMetadata[cellRef]) wsMetadata[cellRef].s = {
                        border: { top: { style: "thin" }, right: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" } }
                    };
                }
                
                // Añadir la hoja de metadatos al libro
                XLSX.utils.book_append_sheet(wb, wsMetadata, "Metadatos");
                
                // Generar el archivo Excel
                const fileName = `Expedientes_Personal_${new Date().toISOString().slice(0, 10)}.xlsx`;
                
                // Escribir el archivo y descargarlo
                setTimeout(() => {
                    XLSX.writeFile(wb, fileName);
                    hideLoading();
                    alert(`Exportación completada. Archivo "${fileName}" descargado.`);
                }, 500);
                
            } catch (error) {
                console.error('Error al exportar a Excel:', error);
                hideLoading();
                alert(`Error al exportar a Excel: ${error.message}`);
            }
        }

        // Función CORREGIDA para guardar un registro de personal
        async function savePersonal() {
            // Protección contra guardados duplicados
            if (isSaving) {
                console.log("Guardado ya en progreso, ignorando solicitud adicional");
                return;
            }
            
            try {
                isSaving = true; // Activar el flag
                
                // Asegurar que hay una sesión válida
                const isValid = await isSessionValid();
                if (!isValid) {
                    throw new Error("No hay sesión activa. Por favor, inicie sesión.");
                }
                
                // CORRECCIÓN AQUÍ - Manejo seguro de la sesión
                const { data, error: sessionError } = await supabaseClient.auth.getSession();
                if (sessionError || !data?.session) {
                    throw new Error("No hay sesión activa. Por favor, inicie sesión.");
                }
                
                const personal = {
                    id: editingPersonalId || Date.now().toString(),
                    nombres: document.getElementById('nombres').value,
                    apellidos: document.getElementById('apellidos').value,
                    edad: document.getElementById('edad').value,
                    jerarquia: document.getElementById('jerarquia').value,
                    sexo: document.getElementById('sexo').value,
                    cedula: document.getElementById('cedula').value,
                    fecha_inicio: document.getElementById('fecha-inicio').value,
                    tipo_expediente: document.getElementById('tipo-expediente').value,
                    icap: document.getElementById('icap').value,
                    condicion: document.getElementById('condicion').value,
                    anio: document.getElementById('anio').value,
                    expediente_penal: document.getElementById('expediente-penal').value,
                    servicio: document.getElementById('servicio').value,
                    tipo_falta: document.getElementById('tipo-falta').value,
                    origen_falta: document.getElementById('origen-falta').value,
                    falta: document.getElementById('falta').value,
                    denunciante: document.getElementById('denunciante').value,
                    detenido: document.getElementById('detenido').value,
                    estatus: document.getElementById('estatus').value,
                    decision: document.getElementById('decision').value,
                    expediente_numero: document.getElementById('expediente-numero').value,
                    registrado_por: document.getElementById('registrado-por').value,
                    sustanciador: document.getElementById('sustanciador').value,
                    remision: document.getElementById('remision').value,
                    resena: document.getElementById('resena').value,
                    causa: document.getElementById('causa').value,
                    fecha_registro: new Date().toISOString().split('T')[0],
                    foto: document.getElementById('profile-picture').src,
                    user_id: data.session.user.id
                };

                // Validación básica
                if (!personal.nombres || !personal.apellidos || !personal.cedula || !personal.jerarquia || !personal.sexo) {
                    throw new Error("Por favor, complete todos los campos obligatorios");
                }

                // Guardar en Supabase
                const { error } = await supabaseClient
                    .from('personal')
                    .upsert([personal], { onConflict: 'id' });
                    
                if (error) throw error;
                
                // Mostrar mensaje de éxito
                alert('Registro de personal guardado exitosamente');
                
                // Limpiar el formulario
                resetPersonalForm();
                
                // Recargar la lista
                await loadPersonal();
            } catch (error) {
                console.error('Error al guardar registro de personal:', error);
                alert(`Error al guardar: ${error.message}`);
            } finally {
                isSaving = false; // Desactivar el flag
            }
        }

        // Función CORREGIDA para cargar los registros de personal
        async function loadPersonal() {
            try {
                // Mostrar loader
                showLoading();
                
                // Asegurar que hay una sesión válida
                const isValid = await isSessionValid();
                if (!isValid) {
                    throw new Error("No hay sesión activa. Por favor, inicie sesión.");
                }
                
                // CORRECCIÓN AQUÍ - Manejo seguro de la sesión
                const { data, error: sessionError } = await supabaseClient.auth.getSession();
                if (sessionError || !data?.session) {
                    throw new Error("No hay sesión activa. Por favor, inicie sesión.");
                }
                
                // Obtener el rol del usuario
                const userRole = data.session.user.user_metadata?.role || 'user';
                currentUserRole = userRole;
                
                // Si el usuario es administrador, obtiene TODOS los registros
                // Si es usuario normal, solo obtiene sus propios registros
                let query = supabaseClient.from('personal').select('*');
                
                if (userRole !== 'admin') {
                    query = query.eq('user_id', data.session.user.id);
                }
                
                const {  personalData, error } = await query.order('fecha_registro', { ascending: false });
                
                if (error) throw error;
                
                // Guardar los datos en la variable global
                allPersonalData = personalData || [];
                filteredPersonalData = [...allPersonalData];
                
                // Si no hay registros
                if (filteredPersonalData.length === 0) {
                    document.getElementById('personal-list').innerHTML = `
                        <tr>
                            <td colspan="9" class="text-center py-4 text-muted">
                                <i class="fas fa-inbox me-2"></i>No hay registros de personal
                            </td>
                        </tr>
                    `;
                    
                    // Actualizar información de paginación
                    paginationInfo.textContent = 'Mostrando 0 de 0 registros';
                    firstPageBtn.disabled = true;
                    prevPageBtn.disabled = true;
                    currentPageBtn.textContent = '1';
                    nextPageBtn.disabled = true;
                    lastPageBtn.disabled = true;
                    
                    hideLoading();
                    return;
                }
                
                // Reiniciar a la primera página
                currentPage = 1;
                
                // Renderizar la primera página
                renderCurrentPage();
                updatePaginationControls();
                
                hideLoading();
                
            } catch (error) {
                console.error('Error al cargar registros de personal:', error);
                document.getElementById('personal-list').innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center py-4 text-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>Error: ${error.message}
                        </td>
                    </tr>
                `;
                hideLoading();
            }
        }

        // Función CORREGIDA para editar un registro de personal
        async function editPersonal(id) {
            try {
                // Obtener el registro de Supabase
                const { data, error } = await supabaseClient
                    .from('personal')
                    .select('*')
                    .eq('id', id)
                    .single();
                    
                if (error) throw error;
                
                if (!data) {
                    throw new Error('Registro no encontrado');
                }
                
                // CORRECCIÓN AQUÍ - Manejo seguro de la sesión
                const {  sessionData, error: sessionError } = await supabaseClient.auth.getSession();
                if (sessionError || !sessionData?.session) {
                    throw new Error("No hay sesión activa. Por favor, inicie sesión.");
                }
                
                // Rellenar el formulario con los datos
                document.getElementById('nombres').value = data.nombres || '';
                document.getElementById('apellidos').value = data.apellidos || '';
                document.getElementById('edad').value = data.edad || '';
                document.getElementById('jerarquia').value = data.jerarquia || '';
                document.getElementById('sexo').value = data.sexo || '';
                document.getElementById('cedula').value = data.cedula || '';
                document.getElementById('fecha-inicio').value = data.fecha_inicio || '';
                document.getElementById('tipo-expediente').value = data.tipo_expediente || '';
                document.getElementById('icap').value = data.icap || '';
                document.getElementById('condicion').value = data.condicion || '';
                document.getElementById('anio').value = data.anio || '';
                document.getElementById('expediente-penal').value = data.expediente_penal || '';
                document.getElementById('servicio').value = data.servicio || '';
                document.getElementById('tipo-falta').value = data.tipo_falta || '';
                document.getElementById('origen-falta').value = data.origen_falta || '';
                document.getElementById('falta').value = data.falta || '';
                document.getElementById('denunciante').value = data.denunciante || '';
                document.getElementById('detenido').value = data.detenido || '';
                document.getElementById('estatus').value = data.estatus || '';
                document.getElementById('decision').value = data.decision || '';
                document.getElementById('expediente-numero').value = data.expediente_numero || '';
                document.getElementById('registrado-por').value = data.registrado_por || '';
                document.getElementById('sustanciador').value = data.sustanciador || '';
                document.getElementById('remision').value = data.remision || '';
                document.getElementById('resena').value = data.resena || '';
                document.getElementById('causa').value = data.causa || '';
                
                // Actualizar la foto
                if (data.foto) {
                    document.getElementById('profile-picture').src = data.foto;
                }
                
                // Establecer el ID de edición
                editingPersonalId = id;
                
                // Desplazar a la sección del formulario
                document.getElementById('personal-form').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                console.error('Error al editar registro de personal:', error);
                alert(`Error al editar: ${error.message}`);
            }
        }

        // Función CORREGIDA para eliminar un registro de personal
        async function deletePersonal(id) {
            try {
                // CORRECCIÓN AQUÍ - Manejo seguro de la sesión
                const { data, error: sessionError } = await supabaseClient.auth.getSession();
                if (sessionError || !data?.session) {
                    throw new Error("No hay sesión activa. Por favor, inicie sesión.");
                }
                
                if (!confirm('¿Está seguro de que desea eliminar este registro de personal?')) {
                    return;
                }
                
                const { error } = await supabaseClient
                    .from('personal')
                    .delete()
                    .eq('id', id);
                    
                if (error) throw error;
                
                alert('Registro de personal eliminado correctamente');
                await loadPersonal();
            } catch (error) {
                console.error('Error al eliminar registro de personal:', error);
                alert(`Error al eliminar: ${error.message}`);
            }
        }

        // Función para reiniciar el formulario
        function resetPersonalForm() {
            document.getElementById('nombres').value = '';
            document.getElementById('apellidos').value = '';
            document.getElementById('edad').value = '';
            document.getElementById('jerarquia').value = '';
            document.getElementById('sexo').value = '';
            document.getElementById('cedula').value = '';
            document.getElementById('fecha-inicio').value = '';
            document.getElementById('tipo-expediente').value = '';
            document.getElementById('icap').value = '';
            document.getElementById('condicion').value = '';
            document.getElementById('anio').value = '';
            document.getElementById('expediente-penal').value = '';
            document.getElementById('servicio').value = '';
            document.getElementById('tipo-falta').value = '';
            document.getElementById('origen-falta').value = '';
            document.getElementById('falta').value = '';
            document.getElementById('denunciante').value = '';
            document.getElementById('detenido').value = '';
            document.getElementById('estatus').value = '';
            document.getElementById('decision').value = '';
            document.getElementById('expediente-numero').value = '';
            document.getElementById('registrado-por').value = '';
            document.getElementById('sustanciador').value = '';
            document.getElementById('remision').value = '';
            document.getElementById('resena').value = '';
            document.getElementById('causa').value = '';
            document.getElementById('profile-picture').src = 'https://placehold.co/200x200/003366/white?text=Foto+Personal';
            
            editingPersonalId = null;
        }

        // Función CORREGIDA para iniciar sesión
        async function login(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const rememberCredentials = document.getElementById('remember-credentials').checked;
            
            try {
                hideError();
                
                // Mostrar spinner de carga
                loginSpinner.classList.remove('d-none');
                loginText.textContent = 'Iniciando sesión...';
                
                console.log('Intentando iniciar sesión con:', email);
                
                // Intenta iniciar sesión
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) {
                    console.error('Error de autenticación:', error);
                    
                    // Manejo específico de errores
                    let errorMessageText = 'Error: ' + error.message;
                    
                    if (error.message.includes('Invalid login credentials')) {
                        errorMessageText = 'Credenciales inválidas. Verifique su correo y contraseña.';
                    } else if (error.message.includes('Email not confirmed')) {
                        errorMessageText = 'Correo no confirmado. Por favor, revise su bandeja de entrada y confirme su cuenta.';
                    } else if (error.message.includes('Email rate limit exceeded')) {
                        errorMessageText = 'Demasiados intentos. Por favor, intente más tarde.';
                    }
                    
                    showError(errorMessageText);
                    
                    // Restaurar el estado del botón
                    loginSpinner.classList.add('d-none');
                    loginText.textContent = 'Iniciar Sesión';
                    
                    return;
                }
                
                console.log('Inicio de sesión exitoso', data);
                
                // Si el usuario quiere recordar sus credenciales, guarda el correo
                if (rememberCredentials) {
                    saveRememberedEmail(email);
                } else {
                    clearRememberedEmail();
                }
                
                // Si llegamos aquí, el inicio de sesión fue exitoso
                loginScreen.style.display = 'none';
                mainPanel.style.display = 'block';
                
                // Carga los registros de personal
                await loadPersonal();
                
                // Actualizar el nombre del usuario
                const userNameElement = document.getElementById('user-name');
                if (userNameElement) {
                    // Manejo seguro de user_metadata
                    const fullName = data.user.user_metadata?.full_name || 
                                    data.user.user_metadata?.fullName || 
                                    data.user.user_metadata?.name ||
                                    data.user.email?.split('@')[0] || 'Usuario';
                    
                    userNameElement.textContent = fullName;
                }
                
                // Restaurar el estado del botón
                loginSpinner.classList.add('d-none');
                loginText.textContent = 'Iniciar Sesión';
                
            } catch (error) {
                console.error('Error inesperado al iniciar sesión:', error);
                showError('Error inesperado: ' + error.message);
                
                // Restaurar el estado del botón
                loginSpinner.classList.add('d-none');
                loginText.textContent = 'Iniciar Sesión';
            }
        }

        // Función para cerrar sesión
        async function logout() {
            try {
                const { error } = await supabaseClient.auth.signOut();
                if (error) throw error;
                
                // Limpiar el correo recordado
                clearRememberedEmail();
                
                // Mostrar pantalla de login
                loginScreen.style.display = 'block';
                mainPanel.style.display = 'none';
                
                // Limpiar el formulario de login
                document.getElementById('email').value = '';
                document.getElementById('password').value = '';
                document.getElementById('remember-credentials').checked = false;
            } catch (error) {
                console.error('Error al cerrar sesión:', error);
                alert('Error al cerrar sesión: ' + error.message);
            }
        }

        // Funciones para mostrar/ocultar formularios
        function showRegisterForm() {
            loginForm.classList.add('d-none');
            registerForm.classList.remove('d-none');
        }

        function showLoginForm() {
            registerForm.classList.add('d-none');
            loginForm.classList.remove('d-none');
        }

        // Configurar eventos para el registro de personal
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Verificar la sesión inicial
                await checkSession();
                
                // Agregar listener para cambios de autenticación
                supabaseClient.auth.onAuthStateChange((event, session) => {
                    console.log('Cambio de estado de autenticación:', event);
                    if (event === 'SIGNED_IN' || event === 'SIGNED_OUT') {
                        // Reiniciar variables globales
                        allPersonalData = [];
                        filteredPersonalData = [];
                        
                        // Verificar la sesión nuevamente
                        checkSession();
                    }
                });
                
                // Configurar el evento de submit del formulario de login
                if (loginForm) {
                    loginForm.addEventListener('submit', login);
                }
                
                // Configurar el evento de submit del formulario de personal
                const personalForm = document.getElementById('personal-form');
                
                if (personalForm) {
                    // Verificar si ya existe un listener para evitar duplicados
                    const formClone = personalForm.cloneNode(true);
                    personalForm.parentNode.replaceChild(formClone, personalForm);
                    
                    formClone.addEventListener('submit', (e) => {
                        e.preventDefault();
                        savePersonal();
                    });
                }
                
                // Configurar botón para exportar a Excel
                if (exportExcelBtn) {
                    exportExcelBtn.addEventListener('click', exportToExcel);
                }
                
                // Configurar botones de navegación
                if (showRegisterBtn) {
                    showRegisterBtn.addEventListener('click', showRegisterForm);
                }
                
                if (showLoginBtn) {
                    showLoginBtn.addEventListener('click', showLoginForm);
                }
                
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', logout);
                }
                
                // Configurar controles de paginación
                if (firstPageBtn) {
                    firstPageBtn.addEventListener('click', () => goToPage(1));
                }
                
                if (prevPageBtn) {
                    prevPageBtn.addEventListener('click', () => goToPage(currentPage - 1));
                }
                
                if (nextPageBtn) {
                    nextPageBtn.addEventListener('click', () => goToPage(currentPage + 1));
                }
                
                if (lastPageBtn) {
                    lastPageBtn.addEventListener('click', () => {
                        const totalPages = Math.ceil(filteredPersonalData.length / itemsPerPage);
                        goToPage(totalPages);
                    });
                }
                
                // Configurar búsqueda
                if (searchPersonal) {
                    searchPersonal.addEventListener('input', function() {
                        const searchTerm = this.value.toLowerCase();
                        
                        if (!searchTerm) {
                            // Si no hay término de búsqueda, mostrar todos los registros
                            filteredPersonalData = [...allPersonalData];
                        } else {
                            // Filtrar los registros
                            filteredPersonalData = allPersonalData.filter(personal => {
                                // Convertir todos los campos a string y buscar en ellos
                                return Object.values(personal).some(value => {
                                    if (value === null || value === undefined) return false;
                                    return value.toString().toLowerCase().includes(searchTerm);
                                });
                            });
                        }
                        
                        // Reiniciar a la primera página
                        currentPage = 1;
                        
                        // Renderizar la primera página
                        renderCurrentPage();
                        updatePaginationControls();
                    });
                }
                
                console.log('Sistema inicializado correctamente');
            } catch (error) {
                console.error('Error al inicializar el sistema:', error);
                alert('Error al inicializar el sistema: ' + error.message);
            }
        });
    </script>
</body>
</html>
