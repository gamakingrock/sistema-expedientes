<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Expedientes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 20px;
        }
        .container {
            max-width: 1200px;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 1px solid #eee;
            padding-bottom: 20px;
        }
        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }
        .expedientes-list {
            max-height: 500px;
            overflow-y: auto;
        }
        .table th {
            background-color: #0d6efd;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Sistema de Gestión de Expedientes</h1>
            <p class="text-muted">Registre y gestione expedientes de manera sencilla</p>
        </div>

        <!-- Pantalla de Login -->
        <div id="login-screen">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h2 class="card-title text-center mb-4">Iniciar Sesión</h2>
                            <form id="login-form">
                                <div class="mb-3">
                                    <label for="email" class="form-label">Correo electrónico</label>
                                    <input type="email" class="form-control" id="email" required>
                                </div>
                                <div class="mb-3">
                                    <label for="password" class="form-label">Contraseña</label>
                                    <input type="password" class="form-control" id="password" required>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">Iniciar Sesión</button>
                                <div class="mt-3 text-center">
                                    <button type="button" class="btn btn-link" id="show-register">¿No tienes cuenta? Regístrate</button>
                                </div>
                            </form>
                            
                            <form id="register-form" class="d-none mt-4">
                                <h3 class="text-center mb-3">Crear Cuenta</h3>
                                <div class="mb-3">
                                    <label for="reg-email" class="form-label">Correo electrónico</label>
                                    <input type="email" class="form-control" id="reg-email" required>
                                </div>
                                <div class="mb-3">
                                    <label for="reg-password" class="form-label">Contraseña</label>
                                    <input type="password" class="form-control" id="reg-password" required>
                                </div>
                                <div class="mb-3">
                                    <label for="reg-name" class="form-label">Nombre completo</label>
                                    <input type="text" class="form-control" id="reg-name" required>
                                </div>
                                <button type="submit" class="btn btn-success w-100">Registrarse</button>
                                <div class="mt-3 text-center">
                                    <button type="button" class="btn btn-link" id="show-login">¿Ya tienes cuenta? Inicia sesión</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sistema Principal (oculto al inicio) -->
        <div id="main-system" class="d-none">
            <div class="row mb-4">
                <div class="col-md-8">
                    <h2>Bienvenido, <span id="user-name"></span></h2>
                    <p class="text-muted">Registra un nuevo expediente</p>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-outline-danger" id="logout-btn">Cerrar sesión</button>
                </div>
            </div>

            <!-- Formulario de Expedientes -->
            <div class="form-section">
                <h3>Nuevo Expediente</h3>
                <form id="expediente-form">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="expediente-numero" class="form-label">Número de Expediente</label>
                            <input type="text" class="form-control" id="expediente-numero" required>
                        </div>
                        <div class="col-md-6">
                            <label for="registrado-por" class="form-label">Registrado por</label>
                            <input type="text" class="form-control" id="registrado-por" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="remision" class="form-label">Remisión</label>
                            <input type="text" class="form-control" id="remision">
                        </div>
                        <div class="col-md-6">
                            <label for="sustanciador" class="form-label">Sustanciador</label>
                            <input type="text" class="form-control" id="sustanciador">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="expediente-penal" class="form-label">Expediente Penal</label>
                            <input type="text" class="form-control" id="expediente-penal">
                        </div>
                        <div class="col-md-6">
                            <label for="expediente-type" class="form-label">Tipo de Expediente</label>
                            <select class="form-select" id="expediente-type">
                                <option value="civil">Civil</option>
                                <option value="penal">Penal</option>
                                <option value="familia">Familia</option>
                                <option value="laboral">Laboral</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="icap" class="form-label">ICAP</label>
                            <input type="text" class="form-control" id="icap">
                        </div>
                        <div class="col-md-6">
                            <label for="start-date" class="form-label">Fecha de Inicio</label>
                            <input type="date" class="form-control" id="start-date">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="rango" class="form-label">Rango</label>
                            <input type="text" class="form-control" id="rango">
                        </div>
                        <div class="col-md-6">
                            <label for="sexo" class="form-label">Sexo</label>
                            <select class="form-select" id="sexo">
                                <option value="masculino">Masculino</option>
                                <option value="femenino">Femenino</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="condicion" class="form-label">Condición</label>
                            <input type="text" class="form-control" id="condicion">
                        </div>
                        <div class="col-md-6">
                            <label for="anio" class="form-label">Año</label>
                            <input type="text" class="form-control" id="anio">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="denunciante" class="form-label">Denunciante</label>
                            <input type="text" class="form-control" id="denunciante">
                        </div>
                        <div class="col-md-6">
                            <label for="servicio" class="form-label">Servicio</label>
                            <input type="text" class="form-control" id="servicio">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="tipo-falta" class="form-label">Tipo de Falta</label>
                            <input type="text" class="form-control" id="tipo-falta">
                        </div>
                        <div class="col-md-6">
                            <label for="falta" class="form-label">Falta</label>
                            <input type="text" class="form-control" id="falta">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="detenido" class="form-label">Detenido</label>
                            <select class="form-select" id="detenido">
                                <option value="si">Sí</option>
                                <option value="no">No</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="estatus" class="form-label">Estatus</label>
                            <input type="text" class="form-control" id="estatus">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="decision" class="form-label">Decisión</label>
                        <textarea class="form-control" id="decision" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="resena" class="form-label">Reseña</label>
                        <textarea class="form-control" id="resena" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="causa" class="form-label">Causa</label>
                        <textarea class="form-control" id="causa" rows="2"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Guardar Expediente</button>
                </form>
            </div>

            <!-- Lista de Expedientes -->
            <div class="form-section">
                <h3>Expedientes Registrados</h3>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Número</th>
                                <th>Registrado por</th>
                                <th>Remisión</th>
                                <th>Sustanciador</th>
                                <th>Expediente Penal</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="expedientes-list">
                            <!-- Los expedientes se cargarán aquí dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Configuración de Supabase (¡REEMPLAZA CON TUS VALORES!)
const supabaseUrl = 'https://sgcozosmelxzsjcecqrl.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNnY296b3NtZWx4enNqY2VjcXJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwMDI4NjYsImV4cCI6MjA2OTU3ODg2Nn0.OpBo_hAeq_EDreiMKiuQyk5o-5nbr8jWcbw4mr0_1I0';


document.getElementById('login-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  console.log("Intentando iniciar sesión...");
  
  try {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    
    console.log("Credenciales ingresadas:", email, "y contraseña");
    
    const { data, error } = await supabase.auth.signInWithPassword({
      email: email,
      password: password
    });
    
    if (error) {
      console.error('Error de autenticación:', error);
      alert('Error: ' + error.message);
      return;
    }
    
    console.log('Inicio de sesión exitoso', data);
    // Redirigir o mostrar interfaz principal
    document.getElementById('login-screen').classList.add('d-none');
    document.getElementById('main-system').classList.remove('d-none');
    document.getElementById('user-name').textContent = email;
    
    // Cargar expedientes
    await loadExpedientes();
    
  } catch (error) {
    console.error('Error inesperado al iniciar sesión:', error);
    alert('Error inesperado: ' + error.message);
  }
});
// Inicialización segura de Supabase
let supabase;
try {
    supabase = supabase.createClient(supabaseUrl, supabaseKey);
    console.log('Supabase inicializado correctamente');
} catch (error) {
    console.error('Error al inicializar Supabase:', error);
    alert('Error de configuración: ' + error.message);
}

// Elementos del DOM
const loginScreen = document.getElementById('login-screen');
const mainSystem = document.getElementById('main-system');
const userNameElement = document.getElementById('user-name');
const expedientesList = document.getElementById('expedientes-list');

// Función para verificar la sesión
async function checkSession() {
    try {
        const { session } = await supabase.auth.getSession(); // ¡CORRECCIÓN AQUÍ!

        if (session) {
            // Usuario autenticado
            loginScreen.classList.add('d-none');
            mainSystem.classList.remove('d-none');

            // Muestra el nombre del usuario
            const user = session.user;
            userNameElement.textContent = user.user_metadata?.full_name || user.email;

            // Carga los expedientes
            await loadExpedientes();
        } else {
            // Usuario no autenticado
            loginScreen.classList.remove('d-none');
            mainSystem.classList.add('d-none');
        }
    } catch (error) {
        console.error('Error al verificar sesión:', error);
        alert('Error al verificar sesión: ' + error.message);
    }
}

// Función para iniciar sesión
async function login(e) {
    e.preventDefault();
    
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;

    
    try {
        console.log('Intentando iniciar sesión con:', email);
        const { data, error } = await supabase.auth.signInWithPassword({
            email: email,
            password: password
        });
        
        if (error) {
            console.error('Error de autenticación:', error);
            alert('Error: ' + error.message);
            return;
        }
        
        console.log('Inicio de sesión exitoso', data);
        await checkSession();
    } catch (error) {
        console.error('Error inesperado al iniciar sesión:', error);
        alert('Error inesperado: ' + error.message);
    }
}

// Función para registrarse
async function register(e) {
    e.preventDefault();
    
    const email = document.getElementById('reg-email').value;
    const password = document.getElementById('reg-password').value;
    const fullName = document.getElementById('reg-name').value;
    
    try {
        console.log('Intentando registrar:', email);
        const { data, error } = await supabase.auth.signUp({
            email: email,
            password: password,
            options: {
                data: {
                    full_name: fullName
                }
            }
        });
        
        if (error) {
            console.error('Error al registrar:', error);
            alert('Error: ' + error.message);
            return;
        }
        
        if (data.user) {
            console.log('Registro exitoso', data);
            alert('¡Cuenta creada! Revisa tu correo para confirmar.');
            showLoginForm();
        } else {
            console.log('Registro pendiente de confirmación', data);
            alert('¡Cuenta creada! Revisa tu correo para confirmar.');
            showLoginForm();
        }
    } catch (error) {
        console.error('Error inesperado al registrar:', error);
        alert('Error inesperado: ' + error.message);
    }
}

// Configura los eventos con manejo de errores
document.addEventListener('DOMContentLoaded', () => {
    try {
        // Configura los eventos
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const expedienteForm = document.getElementById('expediente-form');
        const logoutBtn = document.getElementById('logout-btn');
        const showRegisterBtn = document.getElementById('show-register');
        const showLoginBtn = document.getElementById('show-login');
        
        if (loginForm) loginForm.addEventListener('submit', login);
        if (registerForm) registerForm.addEventListener('submit', register);
        if (expedienteForm) expedienteForm.addEventListener('submit', saveExpediente);
        if (logoutBtn) logoutBtn.addEventListener('click', logout);
        if (showRegisterBtn) showRegisterBtn.addEventListener('click', showRegisterForm);
        if (showLoginBtn) showLoginBtn.addEventListener('click', showLoginForm);
        
        // Verifica la sesión
        checkSession();
        
        console.log('Event listeners configurados correctamente');
    } catch (error) {
        console.error('Error al configurar eventos:', error);
        alert('Error al configurar el sistema: ' + error.message);
    }
});

// Resto de las funciones (saveExpediente, loadExpedientes, etc.)
// ¡Mantén el resto del código igual!
        // Función para cerrar sesión
        async function logout() {
            try {
                const { error } = await supabase.auth.signOut();
                
                if (error) throw error;
                
                // Actualiza la interfaz
                loginScreen.classList.remove('d-none');
                mainSystem.classList.add('d-none');
                
                // Limpia el formulario de login
                document.getElementById('email').value = '';
                document.getElementById('password').value = '';
            } catch (error) {
                alert('Error al cerrar sesión: ' + error.message);
            }
        }

        // Función para guardar un expediente
        async function saveExpediente(e) {
            e.preventDefault();
            
            const expediente = {
                expediente_numero: document.getElementById('expediente-numero').value,
                registrado_por: document.getElementById('registrado-por').value,
                remision: document.getElementById('remision').value,
                sustanciador: document.getElementById('sustanciador').value,
                expediente_penal: document.getElementById('expediente-penal').value,
                expediente_type: document.getElementById('expediente-type').value,
                icap: document.getElementById('icap').value,
                start_date: document.getElementById('start-date').value,
                rango: document.getElementById('rango').value,
                sexo: document.getElementById('sexo').value,
                condicion: document.getElementById('condicion').value,
                anio: document.getElementById('anio').value,
                denunciante: document.getElementById('denunciante').value,
                servicio: document.getElementById('servicio').value,
                tipo_falta: document.getElementById('tipo-falta').value,
                falta: document.getElementById('falta').value,
                detenido: document.getElementById('detenido').value,
                estatus: document.getElementById('estatus').value,
                decision: document.getElementById('decision').value,
                resena: document.getElementById('resena').value,
                causa: document.getElementById('causa').value,
                user_id: supabase.auth.user().id
            };
            
            try {
                const { data, error } = await supabase
                    .from('expedientes')
                    .insert([expediente]);
                
                if (error) throw error;
                
                alert('Expediente guardado correctamente');
                
                // Limpia el formulario
                document.getElementById('expediente-form').reset();
                
                // Recarga los expedientes
                loadExpedientes();
            } catch (error) {
                alert('Error al guardar expediente: ' + error.message);
            }
        }

        // Función para cargar expedientes
        async function loadExpedientes() {
            try {
                const { data, error } = await supabase
                    .from('expedientes')
                    .select('*')
                    .eq('user_id', supabase.auth.user().id)
                    .order('start_date', { ascending: false });
                
                if (error) throw error;
                
                // Limpia la lista
                expedientesList.innerHTML = '';
                
                // Agrega los expedientes a la tabla
                data.forEach(exp => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${exp.expediente_numero || 'N/A'}</td>
                        <td>${exp.registrado_por || 'N/A'}</td>
                        <td>${exp.remision || 'N/A'}</td>
                        <td>${exp.sustanciador || 'N/A'}</td>
                        <td>${exp.expediente_penal || 'N/A'}</td>
                        <td>${exp.start_date ? new Date(exp.start_date).toLocaleDateString() : 'N/A'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary edit-expediente" data-id="${exp.id}">Editar</button>
                            <button class="btn btn-sm btn-danger delete-expediente" data-id="${exp.id}">Eliminar</button>
                        </td>
                    `;
                    expedientesList.appendChild(row);
                });
                
                // Agrega eventos a los botones
                document.querySelectorAll('.edit-expediente').forEach(button => {
                    button.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        editExpediente(id);
                    });
                });
                
                document.querySelectorAll('.delete-expediente').forEach(button => {
                    button.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        deleteExpediente(id);
                    });
                });
                
            } catch (error) {
                alert('Error al cargar expedientes: ' + error.message);
            }
        }

        // Función para editar un expediente (placeholder)
        function editExpediente(id) {
            alert('Funcionalidad de edición en desarrollo. ID: ' + id);
        }

        // Función para eliminar un expediente
        async function deleteExpediente(id) {
            if (!confirm('¿Estás seguro de que deseas eliminar este expediente?')) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('expedientes')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                alert('Expediente eliminado correctamente');
                
                // Recarga los expedientes
                loadExpedientes();
            } catch (error) {
                alert('Error al eliminar expediente: ' + error.message);
            }
        }

        // Funciones para mostrar/ocultar formularios
        function showRegisterForm() {
            document.getElementById('login-form').classList.add('d-none');
            document.getElementById('register-form').classList.remove('d-none');
        }

        function showLoginForm() {
            document.getElementById('register-form').classList.add('d-none');
            document.getElementById('login-form').classList.remove('d-none');
        }
    </script>
</body>
</html>
