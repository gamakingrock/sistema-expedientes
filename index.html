<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administración de Desplegables</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .option-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .delete-option {
            background-color: red;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Modal de Administración de Desplegables -->
    <div class="modal fade" id="manageDropdownModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="manageDropdownModalLabel">Administrar Opciones: <span id="dropdown-field-name"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="new-option-value" class="form-label">Nueva opción</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="new-option-value" placeholder="Ingresar valor de la opción">
                            <input type="text" class="form-control" id="new-option-label" placeholder="Ingresar etiqueta de la opción">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="new-option-global">
                                <label class="form-check-label" for="new-option-global">Global</label>
                            </div>
                            <button id="btn-add-option" class="btn btn-primary">Agregar</button>
                        </div>
                    </div>
                    
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Opción</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="options-list">
                            <!-- Las opciones se cargarán aquí dinámicamente -->
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Configuración de Supabase
        const supabaseUrl = 'TU_URL_SUPABASE';
        const supabaseKey = 'TU_CLAVE_SUPABASE';
        const { createClient } = supabase;
        const supabaseClient = createClient(supabaseUrl, supabaseKey);

        // Variables globales
        let currentDropdownField = null;

        // Función para abrir el modal de administración
        function openManageDropdownModal(field) {
            currentDropdownField = field;
            dropdownFieldName.textContent = field.split('-').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');

            // Cargar opciones actuales
            loadDropdownOptions(field);

            // Mostrar el modal
            const modal = new bootstrap.Modal(document.getElementById('manageDropdownModal'));
            modal.show();
        }

        // Función para cargar opciones desde la base de datos
        async function loadDropdownOptions(field) {
            try {
                const { data, error } = await supabaseClient.from('dropdown_options').select('*').eq('field_name', field);
                if (error) throw error;

                const optionsList = document.getElementById('options-list');
                optionsList.innerHTML = '';

                data.forEach(option => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${option.option_label}</td>
                        <td>
                            <button class="btn btn-danger delete-option" data-id="${option.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    optionsList.appendChild(row);
                });

                // Configurar eventos para los botones de eliminación
                document.querySelectorAll('.delete-option').forEach(button => {
                    button.addEventListener('click', function () {
                        const id = this.getAttribute('data-id');
                        deleteOption(id);
                    });
                });
            } catch (error) {
                console.error(`Error al cargar opciones para ${field}:`, error);
            }
        }

        // Función para agregar una nueva opción
        async function addOption() {
            const newValue = document.getElementById('new-option-value').value.trim();
            const newLabel = document.getElementById('new-option-label').value.trim();
            const isGlobal = document.getElementById('new-option-global').checked;

            if (!newValue || !newLabel) {
                alert('Por favor, complete ambos campos');
                return;
            }

            try {
                // Manejo seguro de la sesión
                const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                if (sessionError || !session) throw new Error("No hay sesión activa. Por favor, inicie sesión.");

                const newOption = {
                    field_name: currentDropdownField,
                    option_value: newValue,
                    option_label: newLabel,
                    user_id: isGlobal ? null : session.user.id,
                    is_global: isGlobal
                };

                const { error } = await supabaseClient.from('dropdown_options').insert([newOption]);
                if (error) throw error;

                // Limpiar campos
                document.getElementById('new-option-value').value = '';
                document.getElementById('new-option-label').value = '';
                document.getElementById('new-option-global').checked = false;

                // Recargar opciones
                loadDropdownOptions(currentDropdownField);

                alert('Opción agregada exitosamente');
            } catch (error) {
                console.error('Error al agregar opción:', error);
                alert(`Error al agregar opción: ${error.message}`);
            }
        }

        // Función para eliminar una opción
        async function deleteOption(id) {
            try {
                const { error } = await supabaseClient.from('dropdown_options').delete().eq('id', id);
                if (error) throw error;

                // Recargar opciones
                loadDropdownOptions(currentDropdownField);

                alert('Opción eliminada exitosamente');
            } catch (error) {
                console.error('Error al eliminar opción:', error);
                alert(`Error al eliminar opción: ${error.message}`);
            }
        }

        // Configurar eventos
        document.getElementById('btn-add-option').addEventListener('click', function () {
            addOption();
        });

        // Inicializar el sistema
        document.addEventListener('DOMContentLoaded', async () => {
            // Abrir modal de administración cuando se hace clic en el icono de configuración
            document.querySelectorAll('.manage-dropdown').forEach(button => {
                button.addEventListener('click', function () {
                    const field = this.getAttribute('data-field');
                    openManageDropdownModal(field);
                });
            });
        });
    </script>
</body>
</html>
